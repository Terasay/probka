
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Форум — ZXC</title>
  <link rel="stylesheet" href="css/style.css">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let t = 'dark';
      try { t = localStorage.getItem('theme') || 'dark'; } catch(e) {}
      const l = document.createElement('link');
      l.rel = 'stylesheet';
      l.id = 'theme-link';
      l.href = 'css/theme-' + t + '.css';
      document.head.appendChild(l);
      document.body.classList.remove('theme-dark', 'theme-pink', 'theme-light', 'theme-gray', 'theme-red', 'theme-cyberpank', 'theme-deep-dark');
      document.body.classList.add('theme-' + t);
    });
  </script>
  <script defer src="js/theme.js"></script>
</head>
<body>
  <div class="page-wrap">
    <nav class="master-menu" role="navigation" aria-label="Главная навигация">
      <div class="nav-inner">
        <div class="nav-left">
          <a href="index.html" class="nav-link">Главная</a>
          <a href="exchange.html" class="nav-link">Биржа</a>
          <a href="news.html" class="nav-link">Новости</a>
          <a href="messenger.html" class="nav-link">Мессенджер</a>
          <a href="forum.html" class="nav-link active">Форум</a>
          <a href="about.html" class="nav-link">О сервере</a>
        </div>
        <div class="nav-right">
          <a href="account.html" class="nav-link account-link">Аккаунт</a>
        </div>
      </div>
    </nav>
    <div class="container">
      <header>
        <h1>Форум</h1>
        <a href="index.html" class="back-btn">← На главную</a>
      </header>
      <section id="forum-topics" class="news-feed">
        <form id="forum-create-form" class="card" style="max-width:600px;margin:0 auto 24px 0;display:none;">
          <h2 style="margin-bottom:12px;">Создать новую тему</h2>
          <input type="text" name="title" placeholder="Заголовок темы" required maxlength="100" style="width:100%;margin-bottom:10px;padding:10px 14px;border-radius:8px;">
          <button type="submit">Создать тему</button>
        </form>
      </section>
      <section id="forum-messages" class="news-feed" style="display:none;">
        <div class="card">
          <button class="back-btn" id="back-to-topics">← К темам</button>
          <h2 id="topic-title"></h2>
          <div id="message-list"></div>
          <div style="margin-top:20px;">
            <textarea id="reply-text" class="forum-input" placeholder="Ваш ответ..."></textarea>
            <button id="send-reply" class="menu-btn">Отправить</button>
          </div>
        </div>
      </section>
      <style>
        .forum-likes {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-top: 6px;
        }
        .forum-like-btn, .forum-dislike-btn {
          background: none;
          border: none;
          font-size: 18px;
          cursor: pointer;
          color: var(--muted);
          transition: color .15s;
        }
        .forum-like-btn.liked, .forum-dislike-btn.liked {
          color: var(--accent);
        }
        .forum-like-count, .forum-dislike-count {
          min-width: 18px;
          text-align: center;
          font-weight: 600;
        }
      </style>
    </div>
    <footer class="footer">
      Terasay Corporation © 2025
    </footer>
  </div>
  <script>
    // Синхронизация window.user, ника в шапке и видимости формы создания темы
    function attachForumCreateHandler() {
      const form = document.getElementById('forum-create-form');
      if (form && !form._handlerAttached) {
        form.addEventListener('submit', async e => {
          e.preventDefault();
          if (!window.user || !window.user.username) {
            alert('Войдите, чтобы создавать темы');
            return;
          }
          const title = form.title.value.trim();
          if (!title) {
            alert('Введите заголовок темы');
            return;
          }
          form.querySelector('button[type="submit"]').disabled = true;
          try {
            const API_URL = window.API_URL || 'http://79.174.78.128:8080';
            const resp = await fetch(`${API_URL}/api/forum/topics/create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title,
                author: window.user.username,
                author_id: window.user.id,
                avatar: window.user.avatar || ''
              })
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data?.error || 'Ошибка создания темы');
            form.title.value = '';
            if (window.loadTopics) window.loadTopics();
            else location.reload();
          } catch (err) {
            alert(err.message);
          }
          form.querySelector('button[type="submit"]').disabled = false;
        });
        form._handlerAttached = true;
      }
    }
    function syncUserAndNavAndForm() {
      let savedUser = null;
      try {
        savedUser = localStorage.getItem('user');
        if (savedUser) {
          window.user = JSON.parse(savedUser);
        } else {
          window.user = null;
        }
      } catch (e) {
        window.user = null;
      }
      // Обновить ник в шапке
      const navBtn = document.querySelector('.nav-link.account-link');
      if (navBtn) {
        navBtn.innerText = (window.user && window.user.username) ? window.user.username : 'Аккаунт';
      }
      // Показать/скрыть форму создания темы
      const form = document.getElementById('forum-create-form');
      if (form) {
        if (window.user && window.user.username) {
          form.style.display = 'block';
          attachForumCreateHandler();
        } else {
          form.style.display = 'none';
        }
      }
    }
    document.addEventListener('DOMContentLoaded', syncUserAndNavAndForm);
    window.addEventListener('user-session-changed', syncUserAndNavAndForm);
    // Слушать изменения localStorage для синхронизации между вкладками
    window.addEventListener('storage', function(e) {
      if (e.key === 'user') {
        window.dispatchEvent(new Event('user-session-changed'));
      }
    });
  </script>
  <script src="js/user-session.js"></script>
  <script src="js/forum.js"></script>
  <!-- showForumCreateForm больше не нужен, всё делается в syncUserAndNavAndForm -->
</body>
</html>
